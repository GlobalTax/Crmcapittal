-- Agregar campos para seguimiento de acuerdos en colaboradores
ALTER TABLE public.collaborators 
ADD COLUMN agreement_id UUID REFERENCES public.documents(id),
ADD COLUMN agreement_status TEXT DEFAULT 'pending' CHECK (agreement_status IN ('pending', 'generated', 'sent', 'signed')),
ADD COLUMN agreement_date TIMESTAMP WITH TIME ZONE,
ADD COLUMN agreement_signed_date TIMESTAMP WITH TIME ZONE;

-- Crear índices para mejorar rendimiento
CREATE INDEX idx_collaborators_agreement_status ON public.collaborators(agreement_status);
CREATE INDEX idx_collaborators_agreement_date ON public.collaborators(agreement_date);

-- Crear plantilla base del acuerdo de colaboración
INSERT INTO public.document_templates (
  name,
  description,
  template_type,
  content,
  variables,
  is_active
) VALUES (
  'Acuerdo de Colaboración - Amigos de Looper',
  'Plantilla automática para generar acuerdos de colaboración con los términos estándar',
  'collaboration_agreement',
  '{
    "content": "<h1>AMIGOS DE LOOPER/DCAPITAL</h1><h2>ACUERDO DE COLABORACIÓN</h2><h3>1. CONDICIONES GENERALES</h3><p>Las presentes condiciones (las \"Condiciones\") regulan la participación del Colaborador en el Programa de Amigos de Looper/Dcapital (el \"Programa\"). Al participar en el Programa, el Colaborador acepta íntegramente estas Condiciones, así como cualquier otro término que Looper establezca en el futuro con respecto al Programa.</p><p>GOLOOPER S.L. (\"LOOPER\") se reserva el derecho de modificar, suspender o cancelar el Programa en cualquier momento mediante notificación escrita o cualquier otro medio de comunicación. Al aceptar participar en el Programa, el Colaborador reconoce haber sido informado expresamente de estas Condiciones.</p><h3>2. PRESENTACIÓN DE LAS PARTES</h3><p>LOOPER es una entidad mercantil especializada en el asesoramiento en operaciones de M&A (compra y venta de empresas), así como en la prestación de servicios complementarios relacionados con dichas operaciones.</p><p>Estos servicios incluyen, entre otros: consultoría estratégica, valoración de empresas, optimización y desarrollo de estrategias de negocio, siendo esta lista meramente enunciativa y no limitativa. Además, LOOPER, directa o indirectamente a través de entidades de su grupo, puede prestar servicios de asesoramiento en materias legales, contables, fiscales, financieras y de consultoría, en cuyo caso LOOPER actuará como un mero intermediario, entre el cliente y la sociedad que preste el servicio de forma efectiva.</p><p>El COLABORADOR {{collaborator_name}}, con email {{collaborator_email}} y teléfono {{collaborator_phone}}, puede ser cualquier persona física o jurídica, independientemente de su actividad profesional o no profesional, que firme el presente acuerdo y manifieste interés en establecer una colaboración con LOOPER en los términos aquí descritos.</p><h3>3. OBJETO DE LA COLABORACIÓN</h3><p>El objeto del presente acuerdo es regular las condiciones de colaboración entre el COLABORADOR y LOOPER, en virtud de la cual el COLABORADOR referirá a LOOPER Potenciales Clientes (los \"Potenciales Clientes\") interesados en realizar una transacción de compra o venta de empresa, sin que el COLABORADOR se encuentre mandatado por dichos clientes.</p><p>Obligación de notificación: LOOPER se compromete a notificar al COLABORADOR, en un plazo de TREINTA (30) DÍAS HÁBILES, si tenía conocimiento previo de la oportunidad de colaboración con el/los Potenciales Clientes antes de ser informado por el COLABORADOR. En caso de que LOOPER ya estuviera o hubiera estado en contacto, de forma directa o indirecta con el Potencial Cliente presentado, este acuerdo de colaboración no será aplicable.</p><h3>4. REFERENCIAS CUALIFICADAS</h3><p>Se considerará Referencia Cualificada (\"Referencia\") cualquier empresa presentada por el COLABORADOR que cumpla los siguientes requisitos:</p><ul><li>No haya tenido contacto previo con LOOPER ni sus empresas vinculadas para explorar una posible operación corporativa, transacción de inversión, o cualquiera de los servicios que LOOPER desarrolla bien de forma directa bien de forma indirecta a través de sus entidades vinculadas u otras sociedades del grupo.</li><li>No haya sido contactada previamente por LOOPER para ofrecerle sus servicios.</li><li>No tenga una relación de control con el COLABORADOR, ni sea una filial de este.</li><li>No tenga una relación laboral con el COLABORADOR, ni que este sea su contratista, representante, director, accionista o directivo.</li></ul><h3>5. RECOMPENSA (REFERRAL''S FEE)</h3><p>Si el COLABORADOR identifica y presenta un Potencial Cliente del cual LOOPER no tenía conocimiento y dicha presentación conduce al cierre exitoso de una Transacción, el COLABORADOR tendrá derecho a una compensación económica en los siguientes términos:</p><ul><li>Compensación Económica: 15% de los honorarios que LOOPER haya percibido en concepto de Intermediación en el cierre de la Transacción.</li></ul><p>Por lo general, los honorarios de LOOPER en concepto de intermediación se estructurarán como una comisión variable a éxito pagadera por el Potencial Cliente a LOOPER tras el cierre efectivo de la Transacción.</p><p>A modo de ejemplo, si el Potencial Cliente referido por el COLABORADOR cierra una Transacción de Venta de participaciones y los honorarios de LOOPER son del 3% + IVA del Valor Total de la Transacción, la estructura de Honorarios entre el COLABORADOR y LOOPER sería la siguiente:</p><ul><li>Honorarios de LOOPER por la intermediación: 3% + IVA del valor de la transacción.</li><li>Valor de la Transacción: €5.000.000 (CINCO MILLONES DE EUROS).</li><li>Honorarios de LOOPER: €150.000 (CIENTO CINCUENTA MIL EUROS) + IVA.</li><li>Honorarios del COLABORADOR: €22.500 (VEINTIDÓS MIL QUINIENTOS EUROS) + IVA.</li></ul><p>Exclusiones: Este 15% no se devengará sobre servicios complementarios prestados por LOOPER al Potencial Cliente antes o después de la Transacción (ej. consultoría previa, valoración, asesoramiento legal, Due Diligence, etc.).</p><h3>6. DEFINICIÓN DE TRANSACCIÓN</h3><p>Se entenderá por Transacción cualquier operación en la que:</p><ul><li>Se realice una Transferencia de Participaciones / Activo y Pasivo de un Potencial Cliente presentado por el COLABORADOR y que haya sido asesorada por LOOPER.</li></ul><h3>7. PAGO DE LA REFERRAL''S FEE</h3><p>El pago de la Referral''s Fee se realizará en un plazo máximo de 30 días hábiles desde que LOOPER reciba el pago de sus honorarios del Potencial Cliente.</p><p>En ningún caso estará LOOPER obligado a realizar el pago de la Referral''s Fee en caso de impago por parte del Potencial Cliente presentado por el COLABORADOR.</p><p>El pago al COLABORADOR estará siempre y en cualquier caso previamente condicionado a que LOOPER haya recibido el pago de sus correspondientes honorarios.</p><h3>8. RESPONSABILIDADES FISCALES</h3><p>Las Referral''s Fees percibidas por el COLABORADOR pueden estar sujetas a impuestos en función de su valor y de la normativa fiscal aplicable a nivel federal, provincial, estatal y local, en la que opere el COLABORADOR.</p><p>El COLABORADOR será el único responsable de declarar dichas recompensas en su declaración de impuestos y de abonar cualquier obligación fiscal derivada.</p><h3>9. ACCIONES DESCALIFICADORAS</h3><p>El Colaborador no debe proporcionar a LOOPER ninguna información que infrinja una relación fiduciaria, un secreto comercial, un acuerdo de confidencialidad u otros derechos de propiedad de terceros, ni podrá divulgar información en violación de ninguna ley o deber contractual.</p><p>LOOPER se reserva el derecho de descalificar en cualquier momento al COLABORADOR del Programa si tiene motivos razonables para creer que ha incumplido alguna de las Condiciones descritas en el presente acuerdo.</p><p>LOOPER se reserva el derecho de descalificar a cualquier COLABORADOR que incumpla estas Condiciones.</p><h3>10. LIMITACIÓN DE RESPONSABILIDAD</h3><p>LOOPER no garantiza que una introducción resulte en una transacción y no asume responsabilidad si la Referencia Cualificada no se traduce en el cierre de una Transacción.</p><p>Asimismo, LOOPER no está obligado a prestar sus servicios a los Potenciales Clientes referidos por el COLABORADOR.</p><p>El COLABORADOR acepta eximir de toda responsabilidad a LOOPER, sus empresas vinculadas, empleados, socios, directores y agentes, frente a cualquier reclamación derivada de su participación en el Programa.</p><h3>11. CONFIDENCIALIDAD</h3><p>Las partes se comprometen a no divulgar información confidencial obtenida en virtud de este acuerdo sin el consentimiento expreso de la otra parte.</p><p>Cualquier publicación del COLABORADOR sobre la relación con LOOPER deberá contar con autorización previa por escrito de un representante legal de LOOPER.</p><h3>12. VIGENCIA DEL CONTRATO</h3><p>El presente acuerdo tendrá vigencia indefinida, pero cualquiera de las partes podrá rescindirlo con un preaviso de 60 días naturales.</p><h3>13. JURISDICCIÓN Y COMPETENCIA</h3><p>En caso de cualquier controversia que surja en relación con el alcance, contenido, interpretación, cumplimiento o incumplimiento de las cláusulas del presente contrato, las Partes se someten de manera expresa a la jurisdicción de los Juzgados y Tribunales de la ciudad de Barcelona, renunciando de forma explícita a cualquier otro fuero que pudiera corresponderles.</p><p>Al participar en el Programa, el COLABORADOR acepta expresamente todas las Condiciones establecidas en este documento.</p><br><br><table style=\"width: 100%; margin-top: 50px;\"><tr><td style=\"width: 50%; text-align: left;\"><strong>En representación del Colaborador:</strong><br><br><br>D./D.º {{collaborator_name}}<br>Fecha: {{agreement_date}}</td><td style=\"width: 50%; text-align: left;\"><strong>En representación de Golooper:</strong><br><br><br>D. LLUIS MIQUEL MONTANYA RAIDO<br>Fecha: {{agreement_date}}</td></tr></table>"
  }',
  '{
    "collaborator_name": "Nombre del colaborador",
    "collaborator_email": "Email del colaborador", 
    "collaborator_phone": "Teléfono del colaborador",
    "agreement_date": "Fecha del acuerdo"
  }',
  true
);